# Задание 7: Аналитика покрытия и качества базы знаний

## Описание

Данное задание реализует систему оценки полноты и качества базы знаний RAG-бота. Включает логирование запросов, автоматическое тестирование на золотом наборе вопросов и анализ пробелов в базе знаний.

## Структура файлов

- `remove_entities.py` - Скрипт для удаления ключевых сущностей из индекса (создание искусственных пробелов)
- `logger.py` - Модуль логирования запросов к RAG-боту
- `golden_questions.txt` - Золотой набор вопросов для тестирования
- `evaluate.py` - Скрипт автоматического тестирования на золотом наборе
- `analyze_logs.py` - Скрипт анализа логов и выявления пробелов
- `sequence_diagram.puml` - Диаграмма последовательности обработки запросов

## Использование

### 1. Создание пробелов в базе знаний

Для тестирования качества бота при отсутствии информации удалите несколько ключевых сущностей:

```bash
cd Task7
python remove_entities.py
```

Скрипт удалит из индекса информацию о:
- Yoda
- Death Star (Звезда Смерти)
- Darth Vader (Дарт Вейдер)

### 2. Запуск автоматического тестирования

Запустите тестирование на золотом наборе вопросов:

```bash
python evaluate.py
```

Скрипт:
- Загрузит вопросы из `golden_questions.txt`
- Выполнит каждый запрос через RAG-движок
- Оценит корректность ответов
- Сохранит результаты в `evaluation_results.json`
- Запишет все запросы в `logs.jsonl`

### 3. Анализ логов

После тестирования проанализируйте логи:

```bash
python analyze_logs.py
```

Скрипт создаст:
- `analysis.json` - Результаты анализа в JSON формате
- `analysis_report.txt` - Текстовый отчет с рекомендациями

## Формат логов

Логи сохраняются в формате JSONL (JSON Lines) в файле `logs.jsonl`. Каждая строка содержит:

```json
{
  "timestamp": "2024-01-01T12:00:00",
  "query": "Кто такой Люк Скайуокер?",
  "answer": "Люк Скайуокер - главный герой...",
  "answer_length": 150,
  "chunks_found": true,
  "chunks_count": 3,
  "sources": [
    {
      "title": "Luke Skywalker",
      "filename": "Luke_Skywalker.txt",
      "distance": 0.23
    }
  ],
  "success": true,
  "reasoning": "Найдено 3 релевантных фрагментов из базы знаний."
}
```

## Золотой набор вопросов

Файл `golden_questions.txt` содержит вопросы в формате:
```
Вопрос | Ожидаемый ответ | Категория | Должен ответить (да/нет)
```

Вопросы разделены на:
- **Известные темы** (бот должен ответить) - 8 вопросов
- **Удаленные темы** (бот не должен ответить) - 5 вопросов

## Диаграмма последовательности

Диаграмма `sequence_diagram.puml` показывает:
- Процесс обработки запроса
- Взаимодействие компонентов системы
- Точки возможных сбоев
- Процесс оценки качества

Для просмотра диаграммы используйте PlantUML или онлайн-сервисы (например, http://www.plantuml.com/plantuml/uml/).

## Результаты

После выполнения всех шагов вы получите:

1. **logs.jsonl** - Логи всех запросов с метаданными
2. **evaluation_results.json** - Результаты автоматического тестирования
3. **analysis_report.txt** - Отчет с выявленными пробелами и рекомендациями
4. **removal_info.json** - Информация об удаленных сущностях

## Рекомендации по улучшению

Отчет `analysis_report.txt` содержит:
- Статистику успешности ответов
- Пробелы по категориям (персонажи, планеты, технологии)
- Примеры неуспешных запросов
- Проблемы с релевантностью источников
- Конкретные рекомендации по улучшению базы знаний

## Зависимости

Установите зависимости:

```bash
pip install -r requirements.txt
```

Убедитесь, что:
- Векторный индекс создан (Task3/build_index.py)
- Настроены переменные окружения для YandexGPT API (Task4/config.py)

