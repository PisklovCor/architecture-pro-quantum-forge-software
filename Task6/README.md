# Задание 6. Автоматическое ежедневное обновление базы знаний

Этот модуль реализует полностью автоматизированный процесс обновления векторного индекса базы знаний: скачивание новых документов, преобразование их в чанки, обновление векторного индекса и логирование.

## Структура проекта

```
Task6/
├── update_index.py          # Основной скрипт обновления индекса
├── requirements.txt         # Зависимости Python
├── schedule_windows.ps1     # Скрипт настройки планировщика для Windows
├── schedule_linux.sh        # Скрипт настройки cron для Linux/macOS
├── architecture.puml        # Диаграмма архитектуры (PlantUML)
├── README.md                # Эта инструкция
├── logs/                    # Директория с логами (создается автоматически)
│   ├── update_index_YYYYMMDD.log
│   └── update_result_YYYYMMDD_HHMMSS.json
└── update_state.json        # Файл состояния (создается автоматически)
```

## Установка

### 1. Установка зависимостей

```bash
cd Task6
pip install -r requirements.txt
```

### 2. Проверка путей

Убедитесь, что существуют следующие директории:
- `Task2/knowledge_base/` - источник данных (база знаний)
- `Task3/chroma_db/` - векторная БД (должна быть создана через `Task3/build_index.py`)

## Использование

### Ручной запуск

Для ручного запуска обновления индекса:

```bash
python update_index.py
```

Скрипт выполнит:
1. Сканирование источника данных (`Task2/knowledge_base/`)
2. Поиск новых или измененных файлов
3. Разбиение документов на чанки
4. Генерацию эмбеддингов
5. Обновление векторной БД
6. Логирование процесса

### Автоматический запуск

#### Windows (Task Scheduler)

1. Откройте PowerShell от имени администратора
2. Перейдите в директорию Task6:
   ```powershell
   cd path\to\Task6
   ```
3. Запустите скрипт настройки:
   ```powershell
   .\schedule_windows.ps1
   ```

Задача будет создана и будет запускаться каждый день в 6:00.

**Просмотр задачи:**
```powershell
Get-ScheduledTask -TaskName "UpdateKnowledgeBaseIndex"
```

**Удаление задачи:**
```powershell
Unregister-ScheduledTask -TaskName "UpdateKnowledgeBaseIndex" -Confirm:$false
```

#### Linux/macOS (Cron)

1. Перейдите в директорию Task6:
   ```bash
   cd path/to/Task6
   ```
2. Сделайте скрипт исполняемым:
   ```bash
   chmod +x schedule_linux.sh
   ```
3. Запустите скрипт настройки:
   ```bash
   ./schedule_linux.sh
   ```

Задача будет добавлена в crontab и будет запускаться каждый день в 6:00.

**Просмотр задач:**
```bash
crontab -l
```

**Удаление задачи:**
```bash
crontab -l | grep -v "update_index.py" | crontab -
```

**Ручное редактирование crontab:**
```bash
crontab -e
```

## Как работает обновление

### Отслеживание изменений

Скрипт использует файл `update_state.json` для отслеживания обработанных файлов. Для каждого файла сохраняется:
- MD5 хеш содержимого
- Время последней модификации
- Количество созданных чанков

При каждом запуске скрипт:
1. Сканирует все `.txt` файлы в `Task2/knowledge_base/`
2. Сравнивает их с сохраненным состоянием
3. Обрабатывает только новые или измененные файлы

### Обработка измененных файлов

Если файл был изменен:
1. Старые чанки этого файла удаляются из индекса
2. Файл обрабатывается заново
3. Новые чанки добавляются в индекс

### Разбиение на чанки

Параметры разбиения (совпадают с Task3):
- **Размер чанка**: 1000 символов
- **Перекрытие**: 200 символов
- **Разделители**: `\n\n`, `\n`, `. `, ` `, ``

### Генерация эмбеддингов

- **Модель**: `BAAI/bge-base-en-v1.5`
- **Размер эмбеддинга**: 768
- **Батч-размер**: 32 чанка

## Логирование

### Логи процесса

Все логи сохраняются в директории `logs/`:
- **Формат имени**: `update_index_YYYYMMDD.log`
- **Содержимое**: подробная информация о процессе обновления
- **Уровни**: INFO, WARNING, ERROR

### Результаты обновления

После каждого запуска создается JSON-файл с результатами:
- **Формат имени**: `update_result_YYYYMMDD_HHMMSS.json`
- **Содержимое**:
  ```json
  {
    "success": true,
    "start_time": "2025-01-17T06:00:00",
    "end_time": "2025-01-17T06:05:30",
    "elapsed_time_seconds": 330.5,
    "updated_files": 3,
    "new_chunks": 45,
    "initial_chunks_count": 1200,
    "final_chunks_count": 1245,
    "errors": []
  }
  ```

### Пример лога

```
2025-01-17 06:00:00 - INFO - ============================================================
2025-01-17 06:00:00 - INFO - Начало обновления векторного индекса
2025-01-17 06:00:00 - INFO - ============================================================
2025-01-17 06:00:00 - INFO - Время запуска: 2025-01-17 06:00:00
2025-01-17 06:00:01 - INFO - Найден новый файл: New_Character.txt
2025-01-17 06:00:05 - INFO - Файл New_Character.txt успешно обработан: добавлено 5 чанков
2025-01-17 06:05:30 - INFO - Обновление завершено
2025-01-17 06:05:30 - INFO - Добавлено новых чанков: 45
2025-01-17 06:05:30 - INFO - Размер индекса после обновления: 1245 чанков
2025-01-17 06:05:30 - INFO - Ошибок: 0
```

## Тестирование

### Тест 1: Добавление нового документа

1. Создайте новый файл в `Task2/knowledge_base/`:
   ```bash
   echo "This is a test document about a new character." > Task2/knowledge_base/Test_Character.txt
   ```

2. Запустите скрипт:
   ```bash
   python update_index.py
   ```

3. Проверьте логи в `logs/update_index_YYYYMMDD.log`

### Тест 2: Изменение существующего документа

1. Отредактируйте существующий файл в `Task2/knowledge_base/`

2. Запустите скрипт:
   ```bash
   python update_index.py
   ```

3. Убедитесь, что старые чанки удалены и добавлены новые

### Тест 3: Запуск без изменений

1. Запустите скрипт дважды подряд:
   ```bash
   python update_index.py
   python update_index.py
   ```

2. Второй запуск должен показать "Новых или измененных файлов не найдено"

## Обработка ошибок

Скрипт обрабатывает следующие ошибки:

1. **База знаний не найдена**: Проверьте путь к `Task2/knowledge_base/`
2. **Векторная БД не найдена**: Сначала запустите `Task3/build_index.py`
3. **Ошибка загрузки модели**: Проверьте подключение к интернету (для первой загрузки)
4. **Ошибка подключения к БД**: Проверьте права доступа к `Task3/chroma_db/`

Все ошибки логируются и сохраняются в JSON-результате.

## Архитектура

Подробная архитектурная диаграмма находится в файле `architecture.puml`. Для просмотра используйте любой PlantUML-редактор или онлайн-сервис (например, http://www.plantuml.com/plantuml/uml/).

### Основные компоненты:

1. **Источник данных** (`Task2/knowledge_base/`) - текстовые файлы с документами
2. **Скрипт обновления** (`update_index.py`) - основной процессор
3. **Векторная БД** (`Task3/chroma_db/`) - ChromaDB с индексами
4. **Модель эмбеддингов** - BGE-base-en-v1.5
5. **Планировщик** - Cron (Linux/macOS) или Task Scheduler (Windows)
6. **Логи** - файлы логов и результатов

## Настройка расписания

### Изменение времени запуска

#### Windows

Отредактируйте `schedule_windows.ps1` и измените строку:
```powershell
$Trigger = New-ScheduledTaskTrigger -Daily -At 6:00AM
```

На нужное время, например:
```powershell
$Trigger = New-ScheduledTaskTrigger -Daily -At 3:00AM
```

#### Linux/macOS

Отредактируйте `schedule_linux.sh` и измените cron-выражение:
```bash
CRON_JOB="0 6 * * * ..."
```

Формат: `минута час день_месяца месяц день_недели`

Примеры:
- `0 6 * * *` - каждый день в 6:00
- `0 */6 * * *` - каждые 6 часов
- `0 0 * * 1` - каждый понедельник в полночь
- `30 2 * * *` - каждый день в 2:30

## Мониторинг

### Проверка последнего обновления

```bash
# Просмотр последнего лога
tail -f logs/update_index_$(date +%Y%m%d).log

# Просмотр последнего результата
ls -t logs/update_result_*.json | head -1 | xargs cat
```

### Размер индекса

После каждого обновления размер индекса записывается в лог и JSON-результат.

## Устранение неполадок

### Проблема: Скрипт не находит новые файлы

**Решение**: Проверьте права доступа к `Task2/knowledge_base/` и `update_state.json`

### Проблема: Ошибка при подключении к ChromaDB

**Решение**: 
1. Убедитесь, что `Task3/chroma_db/` существует
2. Проверьте, что индекс был создан через `Task3/build_index.py`
3. Проверьте права доступа к директории

### Проблема: Модель не загружается

**Решение**: 
1. Проверьте подключение к интернету (для первой загрузки)
2. Убедитесь, что установлены все зависимости: `pip install -r requirements.txt`

### Проблема: Cron задача не запускается

**Решение**:
1. Проверьте, что cron-сервис запущен: `systemctl status cron` (Linux)
2. Проверьте логи cron: `grep CRON /var/log/syslog` (Linux)
3. Убедитесь, что пути в cron-задаче абсолютные

## Дополнительные возможности

### Добавление других источников данных

Для добавления других источников (S3, Git, RSS) можно модифицировать функцию `find_new_or_modified_files()` в `update_index.py`.

### Уведомления

Можно добавить отправку уведомлений (email, Telegram) при ошибках, модифицировав функцию `update_index()`.

### Резервное копирование

Рекомендуется настроить резервное копирование `Task3/chroma_db/` перед обновлением.

## Контакты и поддержка

При возникновении проблем проверьте:
1. Логи в `logs/`
2. Файл состояния `update_state.json`
3. Результаты обновления в JSON-файлах

